# -*- makefile -*-
# $Id: Makefile.in,v 1.2 2000/11/12 18:05:48 emma Exp $

VERSION = 2.0b4-ma1

srcdir = @srcdir@
VPATH = @srcdir@

# Programs
CC      = @CC@
INSTALL = @INSTALL@
RANLIB  = @RANLIB@
AWK	= @AWK@
AR	= @AR@

# Libraries
PCRELIB = @PCRELIB@
LINKPCRELIB = @LINKPCRELIB@
CRYPTLIB = @CRYPTLIB@

# Flags
DEBUG  = -g
STRIP  =
CFLAGS = @CFLAGS@ -I. @DEFS@ @GCC_FLAGS@ $(DEBUG)
LIBS   = @LIBS@

# Directories and Paths
# News is stored in SPOOLDIR, configuration is kept in LIBDIR
# LOCKFILE is the lockfile generated by the leafnode programs
PREFIX_USR = @prefix@
PREFIX_VAR = /var
USRDIR = $(PREFIX_USR)/bin
BINDIR = $(PREFIX_USR)/sbin
MANDIR = $(PREFIX_USR)/man
SPOOLDIR = @SPOOLDIR@
LIBDIR   = @sysconfdir@
LOCKFILE = @LOCKFILE@

# RPM crap
RPM = @RPM@

MANFILES = newsq.1 fetchnews.5 applyfilter.8 checkgroups.8 fetchnews.8 \
	   leafnode.8 rnews.8 texpire.8
SRCFILES = nntputil.c configutil.c xoverutil.c activutil.c miscutil.c \
	   artutil.c filterutil.c localutil.c config.c \
	   applyfilter.c checkgroups.c newsq.c nntpd.c fetchnews.c texpire.c \
	   rnews.c \
	   vsnprintf.c strdup.c
LIBFILES = nntputil.o configutil.o xoverutil.o activutil.o miscutil.o \
	   artutil.o filterutil.o localutil.o \
	   vsnprintf.o strdup.o get_any.o

all: liblnutil.a @PCRELIB@ nntpd rnews fetchnews texpire checkgroups applyfilter newsq

leafnode.h: get.h
	touch $@

liblnutil.a: $(LIBFILES) leafnode.h
	$(AR) rc liblnutil.a $(LIBFILES)
	$(RANLIB) liblnutil.a

libpcre.a: pcre/libpcre.a
	@cp pcre/libpcre.a libpcre.a

pcre/libpcre.a:
	@echo "Building Philip Hazel's Perl regular expressions library..."
	@cd pcre && $(MAKE) $(MFLAGS) -$(MAKEFLAGS) libpcre.a

nntpd: nntpd.o config.o liblnutil.a @CRYPTLIB@
	$(CC) $(CFLAGS) -o $@ nntpd.o config.o -L. -llnutil $(CRYPTLIB) $(LIBS)

rnews: rnews.o config.o liblnutil.a
	$(CC) $(CFLAGS) -o $@ rnews.o config.o -L. -llnutil $(LIBS)

fetchnews: fetchnews.o config.o liblnutil.a @PCRELIB@
	$(CC) $(CFLAGS) -o $@ fetchnews.o config.o -L. -llnutil $(LINKPCRELIB) $(LIBS)

texpire: texpire.o config.o liblnutil.a
	$(CC) $(CFLAGS) -o $@ texpire.o config.o -L. -llnutil $(LIBS)

checkgroups: checkgroups.o config.o liblnutil.a
	$(CC) $(CFLAGS) -o $@ checkgroups.o config.o -L. -llnutil $(LIBS)

applyfilter: applyfilter.o config.o liblnutil.a @PCRELIB@
	$(CC) $(CFLAGS) -o $@ applyfilter.o config.o -L. -llnutil $(LINKPCRELIB) $(LIBS)

newsq: newsq.o config.o liblnutil.a
	$(CC) $(CFLAGS) -o $@ newsq.o config.o -L. -llnutil $(LIBS)

nntpd.o: nntpd.c leafnode.h
	$(CC) -c $(CFLAGS) $(srcdir)/nntpd.c

rnews.o: rnews.c leafnode.h
	$(CC) -c $(CFLAGS) $(srcdir)/rnews.c

fetchnews.o: fetchnews.c leafnode.h
	$(CC) -c $(CFLAGS) $(srcdir)/fetchnews.c

texpire.o: texpire.c leafnode.h
	$(CC) -c $(CFLAGS) $(srcdir)/texpire.c

checkgroups.o: checkgroups.c leafnode.h
	$(CC) -c $(CFLAGS) $(srcdir)/checkgroups.c

applyfilter.o: applyfilter.c leafnode.h
	$(CC) -c $(CFLAGS) $(srcdir)/applyfilter.c

newsq.o: newsq.c leafnode.h
	$(CC) -c $(CFLAGS) $(srcdir)/newsq.c

.PHONY:	clean distclean realclean
clean:
	rm -f *.o *.a
	cd pcre && $(MAKE) $(MFLAGS) -$(MAKEFLAGS) clean

realclean: distclean

distclean: clean
	rm -f core nntpd fetchnews texpire checkgroups applyfilter newsq
	rm -f rnews
	rm -f config.h Makefile pcre/Makefile *.rej *.orig
	rm -f config.status config.cache config.log

update:
	@$(srcdir)/update.sh $(SPOOLDIR) $(LIBDIR) $(LOCKFILE)

depend:
	makedepend *.c 2> /dev/null

config.o: config.c Makefile
	$(CC) -c -DSPOOLDIR=\"$(SPOOLDIR)\" \
		-DLIBDIR=\"$(LIBDIR)\" \
		-DBINDIR=\"$(BINDIR)\" \
		-DLOCKFILE=\"$(LOCKFILE)\" \
		-DVERSION=\"$(VERSION)\" $<

install-strip:
	$(MAKE) $(MFLAGS) -$(MAKEFLAGS) install STRIP=-s

install: liblnutil.a nntpd fetchnews texpire checkgroups applyfilter newsq
	$(INSTALL) -d -o root -g 0 -m 755 $(INSTALLROOT)$(MANDIR)/man1
	$(INSTALL) -d -o root -g 0 -m 755 $(INSTALLROOT)$(MANDIR)/man7
	$(INSTALL) -d -o root -g 0 -m 755 $(INSTALLROOT)$(MANDIR)/man8
	$(INSTALL) -d -o root -g bin -m 755 $(INSTALLROOT)$(BINDIR)
	$(INSTALL) -d -o root -g bin -m 755 $(INSTALLROOT)$(USRDIR)
	$(INSTALL) -c -g news -m 750 -o news $(STRIP) nntpd $(INSTALLROOT)$(BINDIR)/leafnode
	$(INSTALL) -c -g news -m 750 -o news $(STRIP) rnews $(INSTALLROOT)$(BINDIR)/rnews
	$(INSTALL) -c -g news -m 4755 -o root $(STRIP) fetchnews $(INSTALLROOT)$(BINDIR)/fetchnews
	$(INSTALL) -c -g news -m 4755 -o root $(STRIP) texpire $(INSTALLROOT)$(BINDIR)/texpire
	$(INSTALL) -c -g news -m 750 -o news $(STRIP) checkgroups $(INSTALLROOT)$(BINDIR)/checkgroups
	$(INSTALL) -c -g news -m 750 -o news $(STRIP) applyfilter $(INSTALLROOT)$(BINDIR)/applyfilter
	$(INSTALL) -c -g news -m 755 -o news $(STRIP) newsq $(INSTALLROOT)$(USRDIR)/newsq
	$(INSTALL) -c -m 644 $(srcdir)/*.8 $(INSTALLROOT)$(MANDIR)/man8
	$(INSTALL) -c -m 644 $(srcdir)/*.5 $(INSTALLROOT)$(MANDIR)/man5
	if test $(PCRELIB) ; then $(INSTALL) -c -m 644 $(srcdir)/pcre/pcre.7 $(INSTALLROOT)$(MANDIR)/man7 ; fi
	$(INSTALL) -c -m 644 $(srcdir)/*.1 $(INSTALLROOT)$(MANDIR)/man1
	-mkdir -p `dirname $(INSTALLROOT)$(LOCKFILE)`
	-mkdir -p $(INSTALLROOT)$(SPOOLDIR) $(INSTALLROOT)$(LIBDIR)
	-mkdir -p $(INSTALLROOT)$(SPOOLDIR)/leaf.node
	-mkdir -p $(INSTALLROOT)$(SPOOLDIR)/local.groups
	-mkdir -p $(INSTALLROOT)$(SPOOLDIR)/failed.postings
	-mkdir -p $(INSTALLROOT)$(SPOOLDIR)/message.id
	-mkdir -p $(INSTALLROOT)$(SPOOLDIR)/interesting.groups
	-mkdir -p $(INSTALLROOT)$(SPOOLDIR)/out.going
	-mkdir -p $(INSTALLROOT)$(SPOOLDIR)/local.groups
	-chown news:news `dirname $(INSTALLROOT)$(LOCKFILE)`
	-chown news:news $(INSTALLROOT)$(SPOOLDIR) $(INSTALLROOT)$(LIBDIR)
	-chown news:news $(INSTALLROOT)$(SPOOLDIR)/leaf.node
	-chown news:news $(INSTALLROOT)$(SPOOLDIR)/local.groups
	-chown news:news $(INSTALLROOT)$(SPOOLDIR)/failed.postings
	-chown news:news $(INSTALLROOT)$(SPOOLDIR)/message.id
	-chown news:news $(INSTALLROOT)$(SPOOLDIR)/interesting.groups
	-chown news:news $(INSTALLROOT)$(SPOOLDIR)/out.going
	-chown news:news $(INSTALLROOT)$(SPOOLDIR)/local.groups
	cp $(srcdir)/config.example $(INSTALLROOT)$(LIBDIR)
	-chown news:news $(INSTALLROOT)$(LIBDIR)/config.example
	-chmod 600 $(INSTALLROOT)$(LIBDIR)/config.example
	-chown -f news:news $(INSTALLROOT)$(LIBDIR)/config
	-chmod -f 600 $(INSTALLROOT)$(LIBDIR)/config
	chmod 2755 $(INSTALLROOT)$(SPOOLDIR)
	@echo Edit /etc/inetd.conf to start $(INSTALLROOT)$(BINDIR)/leafnode and restart inetd.
	@echo Also read the instructions on updating in the README file.

uninstall-bins:
	-rm $(BINDIR)/fetchnews
	-rm $(BINDIR)/checkgroups
	-rm $(BINDIR)/texpire
	-rm $(BINDIR)/leafnode
	-rm $(BINDIR)/rnews
	-rm $(BINDIR)/applyfilter
	-rm $(USRDIR)/newsq
	-rm $(MANDIR)/man8/fetchnews.8
	-rm $(MANDIR)/man8/rnews.8
	-rm $(MANDIR)/man8/checkgroups.8
	-rm $(MANDIR)/man8/texpire.8
	-rm $(MANDIR)/man8/leafnode.8
	-rm $(MANDIR)/man8/applyfilter.8
	-rm $(MANDIR)/man5/fetchnews.5
	-rm $(MANDIR)/man1/newsq.1
	if test $(PCRELIB) ; then rm ($INSTALLROOT)$(MANDIR)/man7/pcre.7 ; fi

uninstall: uninstall-bins
	-rm -r $(LIBDIR)
	-rm -r $(SPOOLDIR)/leaf.node
	-rm -r $(SPOOLDIR)/interesting.groups
	-rm -r $(SPOOLDIR)/message.id/*
	-rmdir $(SPOOLDIR)/out.going
	@echo Edit /etc/inetd.conf to remove $(BINDIR)/leafnode and restart inetd

dist:	distclean
	autoheader
	autoconf
	mkdir -p leafnode-$(VERSION)
	cp $(MANFILES) leafnode.h acconfig.h $(SRCFILES) \
		INSTALL README CREDITS TODO ChangeLog FAQ \
		config.example config.h.in configure.in Makefile.in \
		configure install-sh aclocal.m4 \
		update.sh makerpm.sh leafnode-$(VERSION).lsm \
		leafnode-$(VERSION)
	chmod 644 leafnode-$(VERSION)/*
	mkdir -p  leafnode-$(VERSION)/doc_german
	chmod 755 leafnode-$(VERSION)/doc_german
	mkdir -p  leafnode-$(VERSION)/doc_catalan
	chmod 755 leafnode-$(VERSION)/doc_catalan
	mkdir -p  leafnode-$(VERSION)/tools
	chmod 755 leafnode-$(VERSION)/tools
	cp -R doc_german/* leafnode-$(VERSION)/doc_german/
	cp doc_catalan/* leafnode-$(VERSION)/doc_catalan/
	cp tools/* leafnode-$(VERSION)/tools/
	chmod 755 leafnode-$(VERSION)/*sh
	chmod 755 leafnode-$(VERSION)/configure
	chmod 755 leafnode-$(VERSION)/tools/*
	tar cf leafnode-$(VERSION).tar leafnode-$(VERSION)
	gzip -f9 leafnode-$(VERSION).tar
	mkdir -p  leafnode-$(VERSION)/pcre
	chmod 755 leafnode-$(VERSION)/pcre
	cp pcre/* leafnode-$(VERSION)/pcre/
	chmod 755 leafnode-$(VERSION)/pcre/perltest
	tar cf leafnode-pcre-$(VERSION).tar leafnode-$(VERSION)
	gzip -f9 leafnode-pcre-$(VERSION).tar
	rm -rf leafnode-$(VERSION)

patch:
	rm -f ../leafnode-$(VERSION).patch
	rm -f ../leafnode-$(VERSION).patch.gz
	@for i in * ; \
	do \
	  if [ -e $$i.orig ] ; \
	  then \
	    echo "diff --unified $$i.orig $$i" ; \
	    diff --unified $$i.orig $$i >> ../leafnode-$(VERSION).patch ; \
	  fi ; \
	done
	gzip -f9 ../leafnode-$(VERSION).patch

configure: configure.in aclocal.m4
	autoconf

config.h.in: stamp-h.in
stamp-h.in: configure.in aclocal.m4 acconfig.h
	autoheader
	echo timestamp >stamp-h.in

config.h: stamp-h
stamp-h: config.h.in config.status
	./config.status

Makefile: Makefile.in config.status
	./config.status

config.status: configure
	./config.status --recheck

rpm: dist
	@./makerpm.sh $(RPM) $(VERSION) $(USRDIR) $(BINDIR) $(MANDIR) $(LOCKFILE) $(SPOOLDIR) $(AWK) $(LIBDIR) $(PREFIX_USR)

# DO NOT DELETE
